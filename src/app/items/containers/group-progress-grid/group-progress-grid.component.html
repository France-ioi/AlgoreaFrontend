<alg-composition-filter
  [defaultValue]="defaultFilter"
  (change)="onFilterChange($event)"
></alg-composition-filter>

<ng-container *ngIf="columns$ | async as columnsState">
  <ng-container *ngIf="rows$ | async as rowsState">
    <alg-error
      *ngIf="rowsState.isError || columnsState.isError; else noError"
      class="dark"
      i18n-message message="Error while loading the data"
      icon="ph-duotone ph-warning-circle"
      [showRefreshButton]="true"
      (refresh)="fetchRows()"
    ></alg-error>

    <ng-template #noError>
      <div class="loader" *ngIf="rowsState.isFetching && (!rowsState.data || rowsState.data.length === 0)">
        <alg-loading></alg-loading>
      </div>

      <p class="empty-message" *ngIf="rowsState.isReady && rowsState.data.length === 0">
        <alg-error
          buttonCaption="Refresh"
          [showRefreshButton]="true"
          (refresh)="fetchRows()"
          i18n
        >
          This group has no {currentFilter, select, Users {users} Teams {teams} other {sub-groups}}
        </alg-error>
      </p>

      <ng-template #menu>
        <div class="menu" cdkMenu (closed)="hideProgressDetail()">
          <alg-user-progress-details
            [canEditPermissions]="canAccess"
            [progressData]="progressOverlay"
            (editPermissions)="onAccessPermissions()"
          ></alg-user-progress-details>
        </div>
      </ng-template>

      <ng-container *ngIf="rowsState.data && columnsState.data && rowsState.data.length > 0">
        <div class="operations">
          <button
            alg-button
            type="button"
            icon="ph ph-file-arrow-down"
            (click)="onCSVExport()"
            [disabled]="isCSVDataFetching"
            i18n
          >Export as CSV</button>
        </div>

        <div class="alg-table-page-wrapper">
          <div class="slanted-grid-sticky-header-bg"></div>
          <table class="alg-table-slanted border-style">
            <thead>
              <tr class="alg-table-header-tr">
                <th class="refresh-th sticky-th">
                  <button
                    class="size-s"
                    icon="pi pi-refresh"
                    (click)="fetchRows()"
                    alg-button-icon
                  ></button>
                </th>
                @for (col of columnsState.data; track $index) {
                  <th class="alg-table-th sticky-th">
                    <div class="alg-table-slanted-header slanted-header">
                      <div class="alg-table-slanted-header-content" pTooltip="{{ col.title }}" tooltipPosition="top" [showDelay]="100">
                        <a
                          class="alg-link cursor-pointer alg-text-bold"
                          [routerLink]="col | itemRoute: { path: itemData.item.id === col.id ? itemData.route.path : itemData.route.path.concat([ itemData.item.id ]) } |
                            with: (itemData.item.id === col.id ? { attemptId } : { parentAttemptId: attemptId }) |
                            url : [ 'progress', 'chapter' ]"
                              *ngIf="itemData && itemData.currentResult && itemData.currentResult.attemptId as attemptId"
                          >{{ col.title }}</a>
                      </div>
                    </div>
                  </th>
                }
              </tr>
            </thead>
            <tbody>
              @for (row of rowsState.data; track row.id) {
                <tr class="alg-table-body-tr">
                  <td class="alg-table-td users-td" pTooltip="{{ row.header }}" tooltipPosition="left" [showDelay]="100">
                    <a
                      class="alg-link cursor-pointer"
                      [routerLink]="{ id: row.id, isUser: currentFilter === 'Users' } | groupLink"
                    >{{ row.header }}</a>
                  </td>
                  @for (col of columnsState.data; track $index; let colIndex = $index) {
                    @if (row.data[colIndex]; as rowData) {
                      <td
                        class="alg-table-td cursor-pointer user-progress-td"
                        (click)="showProgressDetail(rowData, row, col)"
                        [cdkMenuTriggerFor]="menu"
                        [cdkMenuPosition]="progressDetailMenuPositions()"
                        data-testid="user-progress-tooltip-target"
                      >
                        @if (rowData.type === 'user') {
                          <alg-user-progress [userProgress]="rowData"></alg-user-progress>
                        }
                      </td>
                    }
                  }
                </tr>
              }
            </tbody>
          </table>
        </div>
        @if (currentFilter === 'Users' && (datapager.canLoadMore$ | async)) {
          <div class="alg-table-load-more">
            <button
              alg-button
              class="size-s stroke load-more"
              icon="ph-duotone ph-arrow-circle-down"
              (click)="fetchMoreRows()"
              [disabled]="rowsState.isFetching"
            >Load more</button>
          </div>
        }
      </ng-container>

    </ng-template>
  </ng-container>
</ng-container>
