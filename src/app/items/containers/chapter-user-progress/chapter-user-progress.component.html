<ng-container *ngIf="state$ | async as state">
  <alg-loading class="alg-flex-1" size="medium" *ngIf="state.isFetching && !state.data"></alg-loading>
  <alg-error
    class="alg-flex-1"
    i18n-message message="Error while loading the user progress"
    [showRefreshButton]="true"
    (refresh)="refresh()"
    *ngIf="state.isError"
  ></alg-error>

  <ng-container *ngIf="state.data">
    <div class="refresh-button">
      <button class="stroke size-s" alg-button icon="ph-duotone ph-arrows-clockwise" (click)="refresh()">
        Refresh
      </button>
    </div>
    <div class="alg-table-page-wrapper">
      <div class="alg-table-horizontal-scroll">
        <table class="alg-table-v2" cdk-table [dataSource]="state.data">
          @for (column of columns(); track column.field) {
            <ng-container [cdkColumnDef]="column.field">
              <th
                class="alg-table-th"
                [class.text-center]="[ 'timeSpent', 'submissions' ].includes(column.field)"
                cdk-header-cell
                *cdkHeaderCellDef
              >{{ column.header }}</th>
              <td
                class="alg-table-td"
                [class.text-center]="[ 'timeSpent', 'submissions' ].includes(column.field)"
                cdk-cell
                *cdkCellDef="let rowData"
              >
                <ng-container [ngSwitch]="column.field">
                  <ng-container *ngSwitchCase="'title'">
                    <ng-container *ngIf="itemData && itemData.currentResult?.attemptId as parentAttemptId">
                      <div>
                        <a
                          class="alg-link"
                          [ngClass]="{ 'disabled font-bold text-black': rowData.id === itemData.item.id }"
                          [routerLink]="rowData | itemRoute: { path: itemData.route.path.concat([ itemData.item.id ]), parentAttemptId } | url"
                        >
                          {{ rowData.title }}
                        </a>
                      </div>
                    </ng-container>
                  </ng-container>
                  <ng-container *ngSwitchCase="'latestActivityAt'">
                    <ng-container *ngIf="rowData.latestActivityAt; else notStarted">
                      {{ rowData.latestActivityAt | date:'short' }}
                    </ng-container>
                    <ng-template #notStarted>
                      <span i18n>Not started</span>
                    </ng-template>
                  </ng-container>
                  <ng-container *ngSwitchCase="'timeSpent'">
                    <ng-container *ngIf="rowData.latestActivityAt">
                      {{ rowData.timeSpent | secToDuration | readable }}
                    </ng-container>
                  </ng-container>
                  <ng-container *ngSwitchCase="'submissions'">
                    <ng-container *ngIf="!['Chapter', 'Skill'].includes(rowData.type) && rowData.latestActivityAt">
                      {{ rowData.submissions }}
                      <span *ngIf="rowData.hintsRequested > 0" i18n>
                      (using {rowData.hintsRequested, plural, =1 {hint} other {{{ rowData.hintsRequested }} hints}})
                    </span>
                    </ng-container>
                  </ng-container>
                  <ng-container *ngSwitchCase="'score'">
                    <alg-score-ring
                      [currentScore]="rowData.score"
                      [isValidated]="rowData.validated"
                      *ngIf="!rowData.noScore && rowData.latestActivityAt"
                    ></alg-score-ring>
                  </ng-container>
                  <ng-container *ngSwitchDefault>
                    {{ rowData[column.field] }}
                  </ng-container>
                </ng-container>
              </td>
            </ng-container>
          }
          @if (state.data.length > 0) {
            <tr class="alg-table-header-tr" cdk-header-row *cdkHeaderRowDef="displayedColumns()"></tr>
          }
          <tr class="alg-table-body-tr" cdk-row *cdkRowDef="let row; columns: displayedColumns()"></tr>
          <tr class="alg-table-body-tr" *cdkNoDataRow>
            <td class="alg-table-td empty-td" [attr.colspan]="displayedColumns().length">
              <span i18n>There is no progress to report for this group/user.</span>
            </td>
          </tr>
        </table>
      </div>
    </div>
  </ng-container>
</ng-container>
