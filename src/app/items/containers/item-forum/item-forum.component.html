@let itemRoute = itemData!.route;

<ng-container *ngrxLet="selected$; let selected">
  @if (options$ | async; as options) {
    <alg-selection
      [items]="options"
      [selected]="selected"
      (change)="onChange($event, options)"
    ></alg-selection>
  }

  @if (selected === 2 && !(isObserving$ | async)) {
    <alg-error
      class="alg-flex-1"
      i18n-message message="You are not currently observing any group."
    ></alg-error>
  } @else {
    @if (state$ | async; as state) {
      @if (state.isFetching && !state.data) {
        <alg-loading class="alg-flex-1" size="medium"></alg-loading>
      }
      @if (state.isError) {
        <alg-error
          class="alg-flex-1"
          icon="ph-duotone ph-warning-circle"
          i18n-message message="Unable to load the recent threads"
          i18n-buttonCaption buttonCaption="Retry"
          [showRefreshButton]="true"
          (refresh)="refresh()"
        ></alg-error>
      }
      @if (state.data) {
        <div class="operation-buttons">
          <button class="size-s stroke" alg-button icon="ph-duotone ph-arrows-clockwise" (click)="refresh()">
            Refresh
          </button>
        </div>
        <div class="alg-table-page-wrapper">
          <div class="alg-table-horizontal-scroll">
            <table
              class="alg-table-v2"
              *ngrxLet="{ threadId: currentThreadInfo$, isVisible : isDiscussionVisible$ } as discussion"
            >
              <thead>
                @if (state.data.length > 0) {
                  <tr class="alg-table-header-tr">
                    <th class="alg-table-th"></th>
                    @if (itemData?.item?.type !== 'Task') {
                      <th class="alg-table-th" i18n>Content</th>
                    }
                    @if (selected !== 0) {
                      <th class="alg-table-th" i18n>User</th>
                    }
                    <th class="alg-table-th" i18n>Status</th>
                    <th class="alg-table-th" i18n># msgs</th>
                    <th class="alg-table-th" i18n>Latest update</th>
                  </tr>
                }
              </thead>
              <tbody>
                @for (rowData of state.data; track $index) {
                  <tr
                    class="alg-table-body-tr"
                    *ngrxLet="{
                      id: { participantId: rowData.participant.id, itemId: rowData.item.id },
                      isVisible: discussion.isVisible && rowData.participant.id === discussion.threadId?.participantId && rowData.item.id === discussion.threadId?.itemId,
                    } as rowThread"
                  >
                    @let rowItemRoute = rowData.item | itemRoute;
                    @let threadItemRoute = rowItemRoute.id === itemRoute.id ? itemRoute : rowItemRoute // itemRoute will be more complete;
                    @let threadItemInfo = { title: rowData.item.title, route: threadItemRoute };
                    <td class="alg-table-td">
                      @if (rowThread.isVisible) {
                        <button class="size-l danger" alg-button type="button" (click)="hideThreadPanel()" i18n>Hide</button>
                      } @else {
                        <button class="size-l" alg-button type="button" (click)="showThreadPanel(rowThread.id, threadItemInfo)" i18n>Show</button>
                      }
                    </td>
                    @if (itemData?.item?.type !== 'Task') {
                      <td class="alg-table-td">
                        <a class="alg-link" [ngClass]="{'disabled': !rowData.item}" [routerLink]="threadItemRoute | url">
                          {{ rowData.item.title }}
                        </a>
                      </td>
                    }
                    @if (selected !== 0) {
                      <td class="alg-table-td">
                        <a class="alg-link" [routerLink]="{ id: rowData.participant.id, isUser: true } | groupLink">
                          {{ rowData.participant | userCaption }}
                        </a>
                      </td>
                    }
                    <td class="alg-table-td">{{ rowData.status | threadStatusDisplay }}</td>
                    <td class="alg-table-td">{{ rowData.messageCount }}</td>
                    <td class="alg-table-td">{{ rowData.latestUpdateAt | date:'short' }}</td>
                  </tr>
                } @empty {
                  <tr class="alg-table-body-tr">
                    <td class="alg-table-td empty-td" [attr.colspan]="6">
                      <div class="empty-message">
                        @if (selected === 0 && itemData) {
                          @if (itemData.item.type === 'Chapter') {
                            <span i18n>
                              You have not requested any help for activities in this chapter. <br>To request help on an activity, click on the
                              <span class="chat-icon ph-duotone ph-chats-circle"></span> button at the top of the page when visiting this activity.
                              You cannot request help on a chapter.
                            </span>
                          }
                          @else if (itemData.item.type === 'Task') {
                            @if (itemData.item.permissions.canRequestHelp) {
                              <span i18n>
                                You have not requested any help for this activity. <br>To request help on this activity, click on the
                                <span class="chat-icon ph-duotone ph-chats-circle"></span> button at the top of the page.
                              </span>
                            } @else {
                              <span i18n>You do not have permission to ask for help on this activity.</span>
                            }
                          }
                        }
                        @else if (selected === 1 || selected === 2) {
                          @if (selected === 1) {
                            <span i18n>You don’t have access to any help request for this activity.</span>
                          } @else {
                            <span i18n>You don’t have access to any help request for that group/user on this activity.</span>
                          }
                          <span i18n>
                            You may only view requests attached to content you have already
                            validated, unless you have been granted the "observing" permission on that content. Some requests may also be restricted
                            to members of specific groups.
                          </span>
                        }
                      </div>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        </div>
      }
    }
  }

</ng-container>
