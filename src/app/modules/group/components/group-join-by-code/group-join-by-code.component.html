<div *ngIf="processing" class="block-ui"></div>
<alg-section-paragraph
  icon="fa fa-user-plus"
  i18n-label label="Let user join using a code"
  [collapsible]="true"
>
  <div class="invitation-code">
    <span class="content-title" i18n>Let users access this group using a password you send them.</span>

    <div class="code-state" *ngIf="codeAdditions">
      <span class="label" *ngIf="codeAdditions.hasCodeNotSet" i18n>There is currently no code set.</span>
      <span class="label" *ngIf="codeAdditions.hasCodeUnused" i18n>This code has not been used yet (or usage resetted).</span>
      <span class="label" *ngIf="codeAdditions.hasUnexpiringCode" i18n>This code can be used multiple times without expiring.</span>
      <ng-container *ngIf="codeAdditions.hasCodeInUse && codeAdditions.durationSinceFirstCodeUse && codeAdditions.durationBeforeCodeExpiration">
        <span class="label green" i18n *ngIf="codeAdditions.durationSinceFirstCodeUse.ms > 0; else disabledUntil">
          This code has been activated {{ codeAdditions.durationSinceFirstCodeUse | toMin | number:'1.0-0' }} minutes ago,
          it will be disabled in {{ codeAdditions.durationBeforeCodeExpiration | toMin | number:'1.0-0' }} minutes.
        </span>
        <ng-template #disabledUntil>
          <span class="label green" i18n>This code will be disabled in {{ codeAdditions.durationBeforeCodeExpiration | toMin | number:'1.0-0' }} minutes.</span>
        </ng-template>
      </ng-container>
      <span class="label red" *ngIf="!codeAdditions.hasCodeNotSet && codeAdditions.hasCodeExpired" i18n>
        This code has expired on {{ codeAdditions.codeExpiration | date:'medium' }}
      </span>
      <alg-button
        label="Generate a code"
        icon="fa fa-plus"
        class="p-button-rounded"
        (click)="generateNewCode()"
        [disabled]="processing"
        *ngIf="codeAdditions.hasCodeNotSet"
      ></alg-button>
    </div>

    <div class="code-info" *ngIf="group && group.code">
      <div class="code-show">
        <span class="label" i18n>Code</span>
        <alg-code-token
          [code]="group.code"
          [showRefresh]="true"
          [showRemove]="true"
          (refresh)="generateNewCode()"
          (remove)="removeCode()"
        ></alg-code-token>
      </div>
      <div class="validity-selector">
        <span class="label" i18n>Validity</span>
        <alg-selection
          [items]="codeLifetimeOptions"
          [selected]="selectedCodeLifetimeOption"
          (change)="changeCodeLifetime($event)"
        ></alg-selection>

        <div class="duration-form-group" *ngIf="selectedCodeLifetimeOption === customCodeLifetimeOption">
          <alg-dhm-duration
            class="alg-duration"
            ngDefaultControl
            [(ngModel)]="codeLifetimeControlValue"
            #control="ngModel"
            required
          ></alg-dhm-duration>
          <alg-button
            icon="fa fa-check"
            class="submit-duration-button"
            (click)="codeLifetimeControlValue && submitCodeLifetime(codeLifetimeControlValue)"
            [disabled]="processing || !codeLifetimeControlValue || !control.dirty || codeLifetimeControlValue.ms === group.codeLifetime?.ms"
            i18n-pTooltip pTooltip="This code will expire after the given duration (reset current expiration)"
            tooltipPosition="right"
            tooltipEvent="hover"
          ></alg-button>
        </div>
      </div>
    </div>

  </div>

</alg-section-paragraph>
