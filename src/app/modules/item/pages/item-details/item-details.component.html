<ng-container *ngIf="itemData$ | async as state">

  <ng-container *ngIf="state.isReady && state.data as itemData">

    <ng-container *ngIf="taskTabs$ | async as taskTabs">
      <alg-item-header [itemData]="itemData" *ngIf="!(fullFrame$ | async)?.active"></alg-item-header>

      <alg-access-code-view
        *ngIf="showAccessCodeField$ | async"
        i18n-sectionLabel sectionLabel="Access to activity"
        i18n-buttonLabel="Button label for joining an item by (group) code" buttonLabel="Access"
        [itemData]="itemData"
        (groupJoined)="reloadItem()"
      ></alg-access-code-view>

      <alg-item-permissions
        *ngIf="watchedGroup$ | async as watchedGroup"
        [itemData]="itemData"
        [watchedGroup]="watchedGroup"
        (changed)="reloadItem()"
      ></alg-item-permissions>

      <nav class="nav-tab" [hidden]="!(showProgressTab$ | async) && taskTabs.length <= 1 && !(itemData.item.permissions | allowsEditingAll) && !progressTab.isActive && !dependenciesTab.isActive && !parametersTab.isActive">
        <a
          class="nav-tab-item"
          [routerLink]="'./'"
          routerLinkActive #contentTab="routerLinkActive"
          [routerLinkActiveOptions]="{ matrixParams: 'ignored', queryParams: 'ignored', paths: 'exact', fragment: 'ignored' }"
          [class.active]="contentTab.isActive"
          [hidden]="taskTabs.length > 1 || editChildrenTab.isActive"
          i18n
        >
          Content
        </a>
        <a
            class="nav-tab-item"
            [routerLink]="'./edit-children'"
            routerLinkActive #editChildrenTab="routerLinkActive"
            [routerLinkActiveOptions]="{ matrixParams: 'ignored', queryParams: 'ignored', paths: 'exact', fragment: 'ignored' }"
            [class.active]="editChildrenTab.isActive"
            [hidden]="taskTabs.length > 1 || !editChildrenTab.isActive"
            i18n
        >
          Content
        </a>
        <ng-container *ngIf="taskTabs.length > 1">
          <a
            *ngFor="let tab of taskTabs"
            class="nav-tab-item cursor-pointer"
            [routerLink]="'./'"
            [class.active]="contentTab.isActive && tab.view === taskView"
            (click)="setTaskTabActive(tab)"
          >
            {{ tab.name }}
          </a>
        </ng-container>
        <a
          [hidden]="!(showProgressTab$ | async) && !progressTab.isActive"
          class="nav-tab-item"
          [routerLink]="'./progress'"
          routerLinkActive #progressTab="routerLinkActive"
          [class.active]="progressTab?.isActive"
        >
          <i class="fa fa-chart-line"></i>
          &nbsp;
          <span i18n>Progress</span>
        </a>
        <a
          [hidden]="!(itemData.item.permissions | allowsEditingAll) && !dependenciesTab.isActive"
          class="nav-tab-item"
          [routerLink]="'./dependencies'"
          routerLinkActive #dependenciesTab="routerLinkActive"
          [routerLinkActiveOptions]="{ matrixParams: 'ignored', queryParams: 'ignored', paths: 'exact', fragment: 'ignored' }"
          [class.active]="dependenciesTab.isActive"
        >
          <span i18n>Dependencies</span>
        </a>
        <a
            [hidden]="!(itemData.item.permissions | allowsEditingAll) && !parametersTab.isActive"
            class="nav-tab-item"
            [routerLink]="'./parameters'"
            routerLinkActive #parametersTab="routerLinkActive"
            [routerLinkActiveOptions]="{ matrixParams: 'ignored', queryParams: 'ignored', paths: 'exact', fragment: 'ignored'}"
            [class.active]="parametersTab.isActive"
        >
          <span i18n>Parameters</span>
        </a>
      </nav>
      <div class="bg-white" [ngClass]="{ 'compensate-margin': !(showProgressTab$ | async) && taskTabs.length <= 1 && !(itemData.item.permissions | allowsEditingAll) }">
        <alg-error
          *ngIf="unknownError"
          [message]="errorMessage"
        ></alg-error>

        <ng-container *ngIf="contentTab.isActive || editChildrenTab.isActive || taskTabs.length > 0">
          <alg-error *ngIf="answerFallbackLink$ | async as fallbackLink">
            <ng-container *ngIf="(taskReadOnly$ | async); else fallback" i18n>Unable to load the answer</ng-container>
            <ng-template #fallback>
              <ng-container i18n>
                Unable to load the answer, <a [routerLink]="fallbackLink" class="alg-link">load your most recent answer</a>
              </ng-container>
            </ng-template>
          </alg-error>

          <ng-container *ngIf="taskConfig$ | async as taskConfig">
            <div *ngIf="taskConfig.readOnly && contentTab.isActive" class="indicator">
              <alg-answer-author-indicator *ngIf="taskConfig.formerAnswer" [answer]="taskConfig.formerAnswer"></alg-answer-author-indicator>
            </div>
            <alg-item-content
              [hidden]="!contentTab.isActive && !editChildrenTab.isActive"
              [itemData]="itemData"
              [taskConfig]="taskConfig"
              [savingAnswer]="(savingAnswer$ | async) ?? false"
              [(taskView)]="taskView"
              [editModeEnabled]="editChildrenTab.isActive"
              (taskTabsChange)="setTaskTabs($event)"
              (scoreChange)="patchStateWithScore($event)"
              (skipSave)="skipBeforeUnload()"
              (refresh)="reloadItem()"
            ></alg-item-content>
          </ng-container>
        </ng-container>
        <alg-item-progress
          *ngIf="progressTab?.isActive"
          [itemData]="itemData"
          [isTaskReadOnly]="(taskReadOnly$ | async) ?? false"
          [savingAnswer]="(savingAnswer$ | async) ?? false"
          (skipSave)="skipBeforeUnload()"
        ></alg-item-progress>

        <ng-container *ngIf="dependenciesTab.isActive">
          <alg-item-dependencies [itemData]="itemData"></alg-item-dependencies>
        </ng-container>

        <ng-container *ngIf="parametersTab.isActive">
          <alg-item-edit-wrapper [itemData]="itemData"></alg-item-edit-wrapper>
        </ng-container>
      </div>
    </ng-container>

  </ng-container>

</ng-container>

<p-dialog
  *ngIf="saveBeforeUnloadError$ | async"
  [visible]="true"
  [modal]="true"
  [closeOnEscape]="false"
  [closable]="false"
  i18n-header header="Leave unsaved task"
>
  <p i18n>You do not appear to be connected to the Internet, if you leave this task you may loose your progress. Are you sure you want to continue?</p>
  <ng-template pTemplate="footer">
    <button
      pButton
      class="p-button-danger"
      i18n-label label="Loose progress and leave the task"
      (click)="skipBeforeUnload()"
    ></button>
    <button
      pButton
      i18n-label label="Retry"
      (click)="retryBeforeUnload()"
    ></button>
  </ng-template>
</p-dialog>
