<ng-container *ngIf="itemData$ | async as state">

  <ng-container *ngIf="state.isReady && state.data as itemData">

    <alg-item-header [itemData]="itemData" *ngIf="!(fullFrameContent$ | async)"></alg-item-header>

    <alg-access-code-view
      *ngIf="showAccessCodeField$ | async"
      i18n-sectionLabel sectionLabel="Access to activity"
      i18n-buttonLabel buttonLabel="Access"
      [itemData]="itemData"
      (groupJoined)="reloadItem()"
    ></alg-access-code-view>

    <nav class="nav-tab">
      <a
        class="nav-tab-item"
        [routerLink]="'./'"
        routerLinkActive #contentTab="routerLinkActive"
        [routerLinkActiveOptions]="{exact: true}"
        [class.active]="contentTab.isActive"
        [hidden]="taskTabs.length > 1"
        i18n
      >
        Content
      </a>
      <ng-container *ngIf="taskTabs.length > 1">
        <a
          *ngFor="let tab of taskTabs"
          class="nav-tab-item cursor-pointer"
          [routerLink]="'./'"
          [class.active]="contentTab.isActive && tab.view === taskView"
          (click)="setTaskTabActive(tab)"
        >
          {{ tab.name }}
        </a>
      </ng-container>
      <a
        *ngIf="!(watchedGroup$ | async) || itemData.item.permissions.canWatch !== 'none' || !contentTab.isActive"
        class="nav-tab-item"
        [routerLink]="'./progress'"
        routerLinkActive #progressTab="routerLinkActive"
        [class.active]="progressTab?.isActive"
      >
        <i class="fa fa-chart-line"></i>
        &nbsp;
        <span i18n>Progress</span>
      </a>
    </nav>
    <div class="bg-white">
      <alg-error
        *ngIf="unknownError"
        i18n-message message="An unknown error occurred. If this problem persists, please contact us."
      ></alg-error>

      <ng-container *ngIf="contentTab.isActive || taskTabs.length > 0">
        <alg-error *ngIf="answerFallbackLink$ | async as fallbackLink">
          <ng-container *ngIf="(taskReadOnly$ | async); else fallback" i18n>Unable to load the answer</ng-container>
          <ng-template #fallback>
            <ng-container i18n>
              Unable to load the answer, <a [routerLink]="fallbackLink" class="alg-link">load your most recent answer</a>
            </ng-container>
          </ng-template>
        </alg-error>

        <ng-container *ngIf="taskConfig$ | async as taskConfig">
          <div *ngIf="taskConfig.readOnly" class="indicator">
            <alg-answer-author-indicator *ngIf="formerAnswer$ | async as answer" [answer]="answer"></alg-answer-author-indicator>
          </div>
          <alg-item-content
            [hidden]="!contentTab.isActive"
            [itemData]="itemData"
            [taskConfig]="taskConfig"
            [(taskView)]="taskView"
            (taskTabsChange)="setTaskTabs($event)"
            (scoreChange)="patchStateWithScore($event)"
          ></alg-item-content>
        </ng-container>
      </ng-container>
      <alg-item-progress
        *ngIf="progressTab?.isActive || !!(watchedGroup$ | async) && !contentTab.isActive"
        [itemData]="itemData"
        [isTaskReadOnly]="(taskReadOnly$ | async) ?? false"
        [savingAnswer]="savingAnswer"
        (skipSave)="skipBeforeUnload()"
      ></alg-item-progress>
    </div>

  </ng-container>

</ng-container>
